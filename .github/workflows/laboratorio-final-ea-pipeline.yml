name: Laboratorio Final - DevSecOps Pipeline Eduardo Araya

on:
  push:
    branches: [ main, 'feature/**' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment for future deployment'
        required: false
        default: 'qa'
        type: choice
        options:
          - qa
          - staging
          - production

env:
  NODE_VERSION: '19'
  APP_NAME: 'laboratorio-final-celula-movies'

jobs:
  # ====================================================
  # ETAPA 1: CLONACIÃ“N DEL REPOSITORIO Y SETUP BÃSICO
  # ====================================================
  setup:
    name: "ğŸ“‹ 1. Repository Setup & Environment Validation"
    runs-on: ubuntu-latest
    outputs:
      node-version: ${{ env.NODE_VERSION }}
      app-name: ${{ env.APP_NAME }}
      repository-url: ${{ github.repositoryUrl }}
      commit-sha: ${{ github.sha }}
      branch-name: ${{ github.ref_name }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Validate Repository Structure
        run: |
          echo "ğŸ” Validating repository structure..."
          
          # Check essential files exist
          if [ ! -f "package.json" ]; then
            echo "âŒ ERROR: package.json not found"
            exit 1
          fi
          
          if [ ! -f "package-lock.json" ]; then
            echo "âŒ ERROR: package-lock.json not found - required for reproducible builds"
            exit 1
          fi
          
          if [ ! -f "Dockerfile" ]; then
            echo "âŒ ERROR: Dockerfile not found"
            exit 1
          fi
          
          # Check Kubernetes manifests
          if [ ! -f "deployment.yml" ]; then
            echo "âŒ ERROR: deployment.yml not found"
            exit 1
          fi
          
          if [ ! -f "service.yml" ]; then
            echo "âŒ ERROR: service.yml not found"
            exit 1
          fi
          
          echo "âœ… Repository structure validation PASSED"
          
      - name: Validate Package Lock Integrity
        run: |
          echo "ğŸ”’ Validating package-lock.json integrity..."
          
          # Check if package-lock.json is valid JSON
          if ! jq empty package-lock.json > /dev/null 2>&1; then
            echo "âŒ ERROR: package-lock.json is not valid JSON"
            exit 1
          fi
          
          # Verify lockfile version and Node.js compatibility
          LOCKFILE_VERSION=$(jq -r '.lockfileVersion' package-lock.json)
          echo "ğŸ“¦ Lockfile version: $LOCKFILE_VERSION"
          
          # Check for package.json and package-lock.json consistency
          PACKAGE_NAME=$(jq -r '.name' package.json)
          LOCKFILE_NAME=$(jq -r '.name' package-lock.json)
          
          if [ "$PACKAGE_NAME" != "$LOCKFILE_NAME" ]; then
            echo "âŒ ERROR: Package name mismatch between package.json and package-lock.json"
            echo "package.json: $PACKAGE_NAME"
            echo "package-lock.json: $LOCKFILE_NAME"
            exit 1
          fi
          
          echo "âœ… Package-lock.json integrity validation PASSED"
          
      - name: Setup Node.js Environment
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'
          
      - name: Install Dependencies (Frozen Lockfile)
        run: |
          echo "ğŸ“¦ Installing project dependencies using package-lock.json as source of truth..."
          
          # Use npm ci with frozen lockfile for reproducible builds
          npm ci --frozen-lockfile --prefer-offline --no-audit --no-fund
          
          echo "âœ… Dependencies installed successfully from lockfile"
          
      - name: Verify Dependency Installation
        run: |
          echo "ğŸ” Verifying dependency installation..."
          
          # Check node_modules exists and has content
          if [ ! -d "node_modules" ]; then
            echo "âŒ ERROR: node_modules directory not found"
            exit 1
          fi
          
          # Verify critical dependencies are installed
          if [ ! -d "node_modules/next" ]; then
            echo "âŒ ERROR: Next.js not found in node_modules"
            exit 1
          fi
          
          if [ ! -d "node_modules/react" ]; then
            echo "âŒ ERROR: React not found in node_modules"
            exit 1
          fi
          
          # Count installed packages
          INSTALLED_PACKAGES=$(ls node_modules | wc -l)
          echo "ğŸ“Š Installed packages: $INSTALLED_PACKAGES"
          
          echo "âœ… Dependency installation verification PASSED"
          
      - name: Validate Application Configuration
        run: |
          echo "ğŸ”§ Validating application configuration..."
          
          # Check if build script exists
          if npm run build --dry-run > /dev/null 2>&1; then
            echo "âœ… Build script available"
          else
            echo "âš ï¸ WARNING: Build script not found or not working"
          fi
          
          # Check if start script exists  
          if npm run start --dry-run > /dev/null 2>&1; then
            echo "âœ… Start script available"
          else
            echo "âš ï¸ WARNING: Start script not found"
          fi
          
          echo "âœ… Application configuration validation completed"
          
      - name: Environment Information Summary
        run: |
          echo "## ğŸ“‹ Repository Setup Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š Environment Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit SHA**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Node.js Version**: ${{ env.NODE_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Application**: ${{ env.APP_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ github.event.inputs.environment || 'qa' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository Structure**: âœ… Valid" >> $GITHUB_STEP_SUMMARY
          echo "- **Package-lock.json**: âœ… Present and Valid" >> $GITHUB_STEP_SUMMARY
          echo "- **Dependencies**: âœ… Installed (Frozen Lockfile)" >> $GITHUB_STEP_SUMMARY
          echo "- **Configuration**: âœ… Validated" >> $GITHUB_STEP_SUMMARY
          echo "- **Docker Files**: âœ… Present" >> $GITHUB_STEP_SUMMARY
          echo "- **Kubernetes Manifests**: âœ… Present" >> $GITHUB_STEP_SUMMARY
          echo "- **Dependency Integrity**: âœ… Verified" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”’ Security & Reproducibility Features" >> $GITHUB_STEP_SUMMARY
          echo "- **Frozen Lockfile**: Ensures reproducible builds" >> $GITHUB_STEP_SUMMARY
          echo "- **Package Integrity**: Validated JSON structure and consistency" >> $GITHUB_STEP_SUMMARY
          echo "- **Cache Optimization**: Node.js cache with lockfile dependency path" >> $GITHUB_STEP_SUMMARY
          echo "- **Dependency Verification**: Critical packages validated post-install" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸš€ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "Pipeline base successfully established. Ready for:" >> $GITHUB_STEP_SUMMARY
          echo "- â­ï¸ **SAST** (Static Application Security Testing)" >> $GITHUB_STEP_SUMMARY  
          echo "- â­ï¸ **SCA** (Software Composition Analysis)" >> $GITHUB_STEP_SUMMARY
          echo "- â­ï¸ **Container Build** and Security Scanning" >> $GITHUB_STEP_SUMMARY
          echo "- â­ï¸ **Deployment** to Kubernetes" >> $GITHUB_STEP_SUMMARY
          echo "- â­ï¸ **DAST** (Dynamic Application Security Testing)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**Laboratorio Final - CÃ©lula Movies | Eduardo Araya | DevSecOps Course**" >> $GITHUB_STEP_SUMMARY
          
      - name: Setup Complete Notification
        run: |
          echo "ğŸ‰ Pipeline setup phase completed successfully!"
          echo "ğŸ“Š Repository: ${{ github.repository }}"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ğŸ”– Commit: ${{ github.sha }}"
          echo "âš™ï¸ Environment: ${{ github.event.inputs.environment || 'qa' }}"
          echo ""
          echo "âœ… Ready for security analysis and deployment phases"
          echo "ğŸ”„ Pipeline will be extended with additional security stages in upcoming features"
